{% extends "layout.html" %}

{% block content %}
<h2 class="text-2xl font-semibold mb-4">Track Cards</h2>

<!-- Bloc de gestion des cartes -->
<div class="mb-8">
    <form method="POST" action="{{ url_for('track') }}">
        <!-- Champ Source -->
        <div class="mb-4">
            <label for="source" class="block text-sm font-medium text-gray-700">Source</label>
            <select id="source" name="source" class="border p-2 rounded w-1/3" onchange="updateCards()">
                {% for status in status_geo %}
                    <option value="{{ status.status_name }}">{{ status.status_name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Champ Target -->
        <div class="mb-4">
            <label for="target" class="block text-sm font-medium text-gray-700">Target</label>
            <select id="target" name="target" class="border p-2 rounded w-1/3">
                {% for status in status_geo %}
                    <option value="{{ status.status_name }}">{{ status.status_name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Sélection de carte avec menu déroulant filtré -->
        <div class="mb-4">
            <label for="card_input" class="block text-sm font-medium text-gray-700">Carte</label>
            <input list="card_list" id="card_input" name="card" placeholder="Chercher une carte..." class="border p-2 rounded w-1/3" oninput="filterOptions('card_input', 'card_list')">
            <datalist id="card_list">
                {% for card in cards %}
                    <option value="{{ card.card_name }}">{{ card.card_name }}</option>
                {% endfor %}
            </datalist>
        </div>

        <button type="submit" name="move_card" class="bg-blue-500 text-white px-4 py-2 rounded">Déplacer la carte</button>
    </form>
</div>

<!-- Historique des opérations -->
<div class="mb-8">
    <h3 class="text-lg font-semibold mb-2">Historique des opérations</h3>
    <table class="min-w-full table-auto">
        <thead>
            <tr class="bg-gray-100">
                <th class="px-4 py-2">Card Name</th>
                <th class="px-4 py-2">Statut Géo</th>
                <th class="px-4 py-2">Timestamp</th>
                <th class="px-4 py-2">Username</th>
                <th class="px-4 py-2">Annuler</th>
            </tr>
        </thead>
        <tbody id="operations_table_body">
            <!-- Les opérations seront ajoutées dynamiquement ici -->
        </tbody>
    </table>
</div>

<!-- Historique des opérations -->
<div class="mb-8">
    <h3 class="text-lg font-semibold mb-2">Historique des opérations</h3>
    <table class="min-w-full table-auto">
        <thead>
            <tr class="bg-gray-100">
                <th class="px-4 py-2">Card Name</th>
                <th class="px-4 py-2">Statut Géo</th>
                <th class="px-4 py-2">Timestamp</th>
                <th class="px-4 py-2">Username</th>
                <th class="px-4 py-2">Annuler</th>
            </tr>
        </thead>
        <tbody id="operations_table_body">
            <!-- Les opérations seront ajoutées dynamiquement ici -->
        </tbody>
    </table>
</div>

<script>
    // Fonction pour récupérer les opérations
    function fetchOperations() {
        fetch('/get_operations')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('operations_table_body');
                tableBody.innerHTML = ''; // Réinitialiser le tableau
                data.forEach(operation => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border px-4 py-2">${operation.card_name}</td>
                        <td class="border px-4 py-2">${operation.statut_geo}</td>
                        <td class="border px-4 py-2">${operation.timestamp}</td>
                        <td class="border px-4 py-2">${operation.username}</td>
                        <td class="border px-4 py-2">
                            <button onclick="confirmDeletion(${operation.id})" class="bg-red-500 text-white px-4 py-2 rounded">Annuler</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            })
            .catch(error => console.error('Erreur lors de la récupération des opérations :', error));
    }

    // Fonction pour confirmer la suppression
    function confirmDeletion(operationId) {
        const confirmation = confirm("Êtes-vous sûr de vouloir annuler cette opération ?");
        if (confirmation) {
            fetch(`/cancel_operation/${operationId}`, { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        alert("Opération annulée avec succès.");
                        fetchOperations(); // Mettre à jour le tableau
                    } else {
                        alert("Erreur lors de l'annulation de l'opération.");
                    }
                })
                .catch(error => console.error('Erreur lors de la suppression de cette opération :', error));
        }
    }

    // Mettre à jour l'historique toutes les 5 secondes
    setInterval(fetchOperations, 5000);

    // Charger les opérations immédiatement au chargement de la page
    document.addEventListener('DOMContentLoaded', fetchOperations);
</script>



<script>
    // Filtre les cartes dynamiquement
    function filterOptions(inputId, datalistId) {
        const input = document.getElementById(inputId);
        const filter = input.value.toUpperCase();
        const datalist = document.getElementById(datalistId);
        const options = datalist.getElementsByTagName('option');

        for (let i = 0; i < options.length; i++) {
            const txtValue = options[i].value || options[i].textContent;
            if (txtValue.toUpperCase().startsWith(filter)) {
                options[i].style.display = ""; // Afficher si cela commence par le texte
            } else {
                options[i].style.display = "none"; // Masquer sinon
            }
        }
    }

    // Mise à jour des cartes en fonction du statut source
    function updateCards() {
        const source = document.getElementById('source').value;

        fetch(`/get_cards_by_status/${source}`)
            .then(response => response.json())
            .then(data => {
                const datalist = document.getElementById('card_list');
                datalist.innerHTML = '';
                data.forEach(card => {
                    const option = document.createElement('option');
                    option.value = card.card_name;
                    datalist.appendChild(option);
                });
            })
            .catch(error => console.error('Erreur lors de la mise à jour des cartes :', error));
    }
</script>

{% endblock %}
