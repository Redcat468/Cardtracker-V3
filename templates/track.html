{% extends "layout.html" %}

{% block content %}
<div class="flex items-center justify-center h-full space-x-4">
    <img src="{{ url_for('static', filename='images/track.png') }}" alt="Target Icon" 
        style="height: 2rem; width: auto;">
    <h1><strong>Track Cards</strong></h1>
</div>

<!-- Bloc de gestion des cartes -->
<div class="mb-8 flex justify-center">
    <form method="POST" action="{{ url_for('track') }}" class="w-full max-w-xs" style="max-width: 500px;">
        <!-- Champ Source -->
        <div class="mb-4 flex items-center">
            <div class="flex items-center justify-center h-full">
                <img src="{{ url_for('static', filename='images/source.png') }}" alt="Source Icon" 
                     style="height: 2rem; width: auto;margin-right: 1rem;">
            </div>
            <div class="w-full">
                <label for="source" class="block text-sm font-medium text-gray-700">Source</label>
                <select id="source" name="source" class="border p-2 rounded w-full" onchange="updateCards()">
                    {% for status in status_geo %}
                        <option value="{{ status.status_name }}" {% if request.form.get('source') == status.status_name %}selected{% endif %}>
                            {{ status.status_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Champ Target -->
        <div class="mb-4 flex items-center">
            <div class="flex items-center justify-center h-full">
                <img src="{{ url_for('static', filename='images/target.png') }}" alt="Target Icon" 
                     style="height: 2rem; width: auto;margin-right: 1rem">
            </div>
            <div class="w-full">
                <label for="target" class="block text-sm font-medium text-gray-700">Target</label>
                <select id="target" name="target" class="border p-2 rounded w-full">
                    {% for status in status_geo %}
                        <option value="{{ status.status_name }}" {% if request.form.get('target') == status.status_name %}selected{% endif %}>
                            {{ status.status_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Sélection de carte avec menu déroulant filtré -->
        <div class="mb-4 flex items-center">
            <div class="flex items-center justify-center h-full">
                <img src="{{ url_for('static', filename='images/sdcard.png') }}" alt="SD Card Icon" 
                    style="height: 2rem; width: auto;margin-right: 1rem">
            </div>
            <div class="w-full">
                <label for="card_input" class="block text-sm font-medium text-gray-700">Carte</label>
                <input list="card_list" id="card_input" name="card" placeholder="Chercher une carte..." 
                       class="border p-2 rounded w-full" onfocus="updateCards()">
                <datalist id="card_list">
                    <!-- Les options seront mises à jour dynamiquement via JavaScript -->
                </datalist>
            </div>
        </div>

        <!-- Champ Statut Offload -->
        <div class="mb-4 flex items-center">
            <div class="flex items-center justify-center h-full">
                <img src="{{ url_for('static', filename='images/offload.png') }}" alt="Offload Icon" 
                    style="height: 2rem; width: auto;margin-right: 1rem;">
            </div>
            <div class="w-full">
                <label for="offload_status" class="block text-sm font-medium text-gray-700">Statut Offload</label>
                <select id="offload_status" name="offload_status" class="border p-2 rounded w-full">
                    {% for status in offload_statuses %}
                        <option value="{{ status.status_name }}" {% if request.form.get('offload_status') == status.status_name %}selected{% endif %}>
                            {{ status.status_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>


        <div class="flex justify-center">
            <button type="submit" name="move_card" class="btn">Déplacer la carte</button>
        </div>
    </form>
</div>


<!-- Historique des opérations -->
<div class="mb-8">
    <h3 class="text-lg font-semibold mb-2">Historique des opérations</h3>
    <table class="min-w-full table-auto">
        <thead>
            <tr class="bg-gray-100">
                <th class="px-4 py-2">Card Name</th>
                <th class="px-4 py-2">Statut Géo</th>
                <th class="px-4 py-2">Statut Offload</th> <!-- Nouvelle colonne -->
                <th class="px-4 py-2">Timestamp</th>
                <th class="px-4 py-2">Username</th>
                <th class="px-4 py-2">Annuler</th>
            </tr>
        </thead>
        <tbody id="operations_table_body">
            <!-- Les opérations seront ajoutées dynamiquement ici -->
        </tbody>
    </table>
</div>


<script>
    // Fonction pour récupérer les opérations
    function fetchOperations() {
        fetch('/get_operations')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('operations_table_body');
                tableBody.innerHTML = ''; // Réinitialiser le tableau
                data.forEach(operation => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border px-4 py-2">${operation.card_name}</td>
                        <td class="border px-4 py-2">${operation.statut_geo}</td>
                        <td class="border px-4 py-2">${operation.offload_status}</td>
                        <td class="border px-4 py-2">${operation.timestamp}</td>
                        <td class="border px-4 py-2">${operation.username}</td>
                        <td class="border px-4 py-2">
                            <button onclick="confirmDeletion(${operation.id})" class="btn btn-logout">Annuler</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            })
            .catch(error => console.error('Erreur lors de la récupération des opérations :', error));
    }

    // Fonction pour confirmer la suppression
    function confirmDeletion(operationId) {
        const confirmation = confirm("Êtes-vous sûr de vouloir annuler cette opération ?");
        if (confirmation) {
            fetch(`/cancel_operation/${operationId}`, { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        alert("Opération annulée avec succès.");
                        fetchOperations(); // Mettre à jour le tableau
                    } else {
                        alert("Erreur lors de l'annulation de l'opération.");
                    }
                })
                .catch(error => console.error('Erreur lors de la suppression de cette opération :', error));
        }
    }

    // Mettre à jour l'historique toutes les 5 secondes
    setInterval(fetchOperations, 5000);

    // Charger les opérations immédiatement au chargement de la page
    document.addEventListener('DOMContentLoaded', fetchOperations);
</script>

<script>
    // Fonction pour mettre à jour les options dans le datalist
    function updateCards() {
        const source = document.getElementById('source').value;
        const datalist = document.getElementById('card_list');
        const cardInput = document.getElementById('card_input');

        // Réinitialiser la valeur du champ d'entrée pour éviter les anciennes sélections
        cardInput.value = '';

        // Récupérer les cartes pour la source sélectionnée
        fetch(`/get_cards_by_status/${source}`)
            .then(response => response.json())
            .then(data => {
                datalist.innerHTML = ''; // Réinitialiser le datalist
                data.forEach(card => {
                    const option = document.createElement('option');
                    option.value = card.card_name;
                    datalist.appendChild(option);
                });

                // Sauvegarder les cartes disponibles pour vérification
                window.availableCards = data.map(card => card.card_name);
            })
            .catch(error => console.error('Erreur lors de la récupération des cartes :', error));
    }

    // Vérification avant d'envoyer le formulaire
    function validateAndSubmitForm(event) {
        const source = document.getElementById('source').value;
        const target = document.getElementById('target').value;
        const cardInput = document.getElementById('card_input').value;

        // Vérification si la carte est dans la liste des cartes disponibles
        if (!window.availableCards || !window.availableCards.includes(cardInput)) {
            event.preventDefault(); // Empêcher l'envoi du formulaire
            alert('Erreur : La carte sélectionnée n’est pas disponible dans la source sélectionnée.');
            return;
        }

        // Vérification si la source et la target sont identiques
        if (source === target) {
            event.preventDefault(); // Empêcher l'envoi du formulaire
            alert('Erreur : La source et la cible ne peuvent pas être identiques.');
            return;
        }

        // Si tout est correct, le formulaire sera envoyé
    }

    // Ajouter un gestionnaire d'événements au bouton "Déplacer la carte"
    document.querySelector('form').addEventListener('submit', validateAndSubmitForm);

    // Appeler la fonction de mise à jour lors de la sélection ou du focus sur le champ
    document.getElementById('card_input').addEventListener('focus', updateCards);
</script>

{% endblock %}