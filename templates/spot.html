{% extends "layout.html" %}

{% block content %}
<h2 class="text-2xl font-semibold mb-4">Spot Cards</h2>

<!-- Include TimelineJS -->
<script src="https://cdn.knightlab.com/libs/timeline3/latest/js/timeline.js"></script>
<link rel="stylesheet" href="https://cdn.knightlab.com/libs/timeline3/latest/css/timeline.css">

<!-- Onglets de navigation -->
<ul class="flex border-b">
    <li class="mr-1">
        <a class="bg-white inline-block py-2 px-4 text-blue-500 font-semibold" href="#" onclick="showTab('operations')">Operations</a>
    </li>
    <li class="mr-1">
        <a class="bg-white inline-block py-2 px-4 text-blue-500 font-semibold" href="#" onclick="showTab('card_focus')">Card Focus</a>
    </li>
    <li class="mr-1">
        <a class="bg-white inline-block py-2 px-4 text-blue-500 font-semibold" href="#" onclick="showTab('status_geo')">Statut Géo</a>
    </li>
</ul>

<!-- Tab content -->
<div id="tab_content" class="mt-4">

    <!-- Card Focus tab -->
    <div id="card_focus" class="tab">
        <h3 class="text-lg font-semibold mb-2">Card Focus</h3>

        <!-- Formulaire pour Card Focus -->
        <form method="POST" action="{{ url_for('spot') }}">
            <input type="hidden" name="action" value="card_focus">
            <input type="hidden" name="current_tab" value="card_focus">
            <input list="card_list" id="card_input" name="selected_card" placeholder="Chercher une carte..." class="border p-2 rounded w-1/3" oninput="filterOptions('card_input', 'card_list')" value="{{ selected_card if selected_card is not none }}">
            <datalist id="card_list">
                {% for card in cards %}
                    <option value="{{ card.card_name }}">{{ card.card_name }}</option>
                {% endfor %}
            </datalist>
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Sélectionner la carte</button>
        </form>

        <!-- Affichage des informations de la carte sélectionnée -->
        {% if card_info %}
        <div class="p-4 mt-4 bg-gray-100 rounded shadow-lg">
            <h4 class="text-xl font-bold">{{ card_info.card_name }} - Informations</h4>
            <ul>
                <li><strong>Capacité:</strong> {{ card_info.capacity }} Go</li>
                <li><strong>Marque:</strong> {{ card_info.brand }}</li>
                <li><strong>Type:</strong> {{ card_info.card_type }}</li>
                <li><strong>Date de naissance:</strong> {{ card_info.card_birth }}</li>
                <li><strong>Statut de quarantaine:</strong> {{ 'Oui' if card_info.quarantine else 'Non' }}</li>
                <li><strong>Usage:</strong> {{ card_info.usage }}</li> <!-- Ajout du champ "usage" -->
            </ul>
        </div>
        {% endif %}

        <!-- Affichage de la timeline -->
        {% if selected_card %}
        <h4 class="mt-4 text-lg font-semibold">Timeline pour la carte {{ selected_card }}</h4>
        <div id="timeline-embed" style="width: 100%; height: 400px"></div>
        <script>
            // Créer l'objet de la timeline avec les données fournies
            var timeline_data = {{ timeline_data | tojson }};
    
            // Initialiser la timeline
            window.timeline = new TL.Timeline('timeline-embed', timeline_data);
    
            // Se positionner sur le dernier événement après le chargement
            window.timeline.on('loaded', function() {
                const defaultPosition = timeline_data.default_position;
                if (defaultPosition !== undefined && defaultPosition >= 0) {
                    window.timeline.goTo(defaultPosition);
                }
            });
        </script>
    {% endif %}
    </div>
    <!-- Statut Géo tab -->
    <div id="status_geo" class="tab">

        <!-- Champ de sélection du statut géographique -->
        <form method="POST" action="{{ url_for('spot') }}">
            <input type="hidden" name="action" value="status_geo">
            <input type="hidden" name="current_tab" value="status_geo">
            <div class="flex items-center space-x-4">
                <select id="status_input" name="selected_status" class="border p-2 rounded w-1/3">
                    <option value="" selected>-- Sélectionnez un statut --</option>
                    {% for status in status_geo %}
                        <option value="{{ status.status_name }}" {% if selected_status == status.status_name %}selected{% endif %}>
                            {{ status.status_name }}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Rechercher
                </button>
            </div>
        </form>

<!-- Tableau des cartes associées au statut sélectionné -->
{% if selected_status and cards_by_status %}
<div class="mt-4">
    <h4 class="text-lg font-semibold mb-2">Cartes pour le statut : {{ selected_status }}</h4>
    <table class="min-w-full table-auto border">
        <thead>
            <tr class="bg-gray-100">
                <th class="px-4 py-2 border">Nom de la Carte</th>
                <th class="px-4 py-2 border">Capacité</th>
                <th class="px-4 py-2 border">Type</th>
                <th class="px-4 py-2 border">Dernière Opération</th>
                <th class="px-4 py-2 border">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for card, last_operation_date in cards_by_status %}
                <tr>
                    <td class="border px-4 py-2">{{ card.card_name }}</td>
                    <td class="border px-4 py-2">{{ card.capacity }} Go</td>
                    <td class="border px-4 py-2">{{ card.card_type }}</td>
                    <td class="border px-4 py-2">
                        {% if last_operation_date %}
                            {{ last_operation_date.strftime('%Y-%m-%d %H:%M:%S') if last_operation_date.__class__.__name__ == 'datetime' else last_operation_date }}
                        {% else %}
                            Aucune
                        {% endif %}
                    </td>
                    <td class="border px-4 py-2">
                        <form method="POST" action="{{ url_for('spot') }}">
                            <input type="hidden" name="action" value="card_focus">
                            <input type="hidden" name="selected_card" value="{{ card.card_name }}">
                            <button type="submit" class="text-blue-500 hover:underline">Voir</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}



    </div>

<script>
    // Gestion des onglets
    function showTab(tabName) {
        var tabs = document.getElementsByClassName('tab');
        for (var i = 0; i < tabs.length; i++) {
            tabs[i].style.display = 'none';  // Masquer tous les onglets
        }
        document.getElementById(tabName).style.display = 'block';  // Afficher l'onglet sélectionné
    }

    // Initialiser l'affichage sur l'onglet "Card Focus"
    document.addEventListener('DOMContentLoaded', function() {
        showTab('card_focus');
    });
</script>

<script>
    // Activer l'onglet correspondant
    document.addEventListener('DOMContentLoaded', function() {
        const activeTab = "{{ current_tab }}";  // Récupérer l'onglet actuel depuis le backend
        showTab(activeTab);
    });
</script>


{% endblock %}
