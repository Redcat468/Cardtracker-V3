{% extends "layout.html" %}

{% block content %}
<div class="flex items-center justify-center h-full space-x-4">
    <img src="{{ url_for('static', filename='images/spot.png') }}" alt="Spot Icon" 
        style="height: 3rem; width: auto;">
    <h1 style="font-size: 2rem; font-weight: 600;">Spot Cards</h1>
    <div style="margin-bottom: 5rem;"></div>
</div>

<!-- Include TimelineJS -->
<script src="https://cdn.knightlab.com/libs/timeline3/latest/js/timeline.js"></script>
<link rel="stylesheet" href="https://cdn.knightlab.com/libs/timeline3/latest/css/timeline.css">

<!-- Onglets de navigation -->
<ul class="flex border-b">

    <li class="mr-1">
        <a href="{{ url_for('spot', current_tab='fast_search') }}"
           class="tab-link inline-block py-2 px-4 {{ 'border-b-4 border-blue-500 text-blue-600' if current_tab == 'fast_search' else 'text-blue-500' }}">
          Recherche Rapide
        </a>
      </li>
    <li class="mr-1">
        <a href="{{ url_for('spot', current_tab='card_focus') }}" 
           class="tab-link inline-block py-2 px-4 {{ 'border-b-4 border-blue-500 text-blue-600' if current_tab == 'card_focus' else 'text-blue-500' }}">
            Card Focus
        </a>
    </li>
    <li class="mr-1">
        <a href="{{ url_for('spot', current_tab='user_focus') }}" 
           class="tab-link inline-block py-2 px-4 {{ 'border-b-4 border-blue-500 text-blue-600' if current_tab == 'user_focus' else 'text-blue-500' }}">
            User Focus
        </a>
    </li>
    <li class="mr-1">
        <a href="{{ url_for('spot', current_tab='geo_focus') }}" 
           class="tab-link inline-block py-2 px-4 {{ 'border-b-4 border-blue-500 text-blue-600' if current_tab == 'geo_focus' else 'text-blue-500' }}">
            Géo Focus
        </a>
    </li>
    <li class="mr-1">
        <a href="{{ url_for('spot', current_tab='offload_focus') }}" 
           class="tab-link inline-block py-2 px-4 {{ 'border-b-4 border-blue-500 text-blue-600' if current_tab == 'offload_focus' else 'text-blue-500' }}">
            Offload Focus
        </a>
    </li>
</ul>


<!-- Contenu des onglets -->
<div class="mt-4">
    {% if current_tab == 'user_focus' %}      <!-- Contenu de user Focus -->
    <!-- User Focus tab -->
        <!-- Champ de sélection de l'utilisateur -->
        <form method="POST" action="{{ url_for('spot') }}"class="w-full max-w-3xl">
            <input type="hidden" name="action" value="user_focus">
            <input type="hidden" name="current_tab" value="user_focus">
            <div class="flex items-center space-x-4">
                <select id="user_input" name="selected_user" class="border p-2 rounded w-1/3">
                    <option value="" selected>-- Sélectionnez un utilisateur --</option>
                    {% for user in users %}
                        <option value="{{ user.username }}" {% if selected_user == user.username %}selected{% endif %}>
                            {{ user.username }}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Rechercher
                </button>
            </div>
        </form>

        <!-- Tableau des opérations associées à l'utilisateur sélectionné -->
        {% if selected_user and user_operations %}
        <div class="mt-4">
            <h4 class="text-lg font-semibold mb-2">Opérations de l'utilisateur : {{ selected_user }}</h4>
            <table class="min-w-full table-auto border">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="px-4 py-2 border">Nom de la Carte</th>
                        <th class="px-4 py-2 border">Statut Géo</th>
                        <th class="px-4 py-2 border">Statut Offload</th>
                        <th class="px-4 py-2 border">Timestamp</th>
                        <th class="px-4 py-2 border">Actions</th> <!-- Nouvelle colonne -->
                    </tr>
                </thead>
                <tbody>
                    {% for operation in user_operations %}
                        <tr>
                            <td class="border px-4 py-2">{{ operation.card_name }}</td>
                            <td class="border px-4 py-2">{{ operation.statut_geo }}</td>
                            <td class="border px-4 py-2">{{operation.offload_status}}</td>
                            <td class="border px-4 py-2">{{ operation.timestamp }}</td>
                            <td class="border px-4 py-2">
                                <form method="POST" action="{{ url_for('spot') }}">
                                    <input type="hidden" name="action" value="card_focus">
                                    <input type="hidden" name="selected_card" value="{{ operation.card_name }}">
                                    <button type="submit" class="text-blue-500 hover:underline">Voir</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

    {% elif current_tab == 'card_focus' %}    <!-- Contenu de Card Focus -->
    <!-- Card Focus tab -->

        <!-- Sélection de carte avec menu déroulant filtré -->
        <form method="POST" action="{{ url_for('spot') }}">
            <input type="hidden" name="current_tab" value="card_focus">
            <input list="card_list" id="card_input" name="selected_card" placeholder="Chercher une carte..." class="border p-2 rounded w-1/3" oninput="filterOptions('card_input', 'card_list')" value="{{ selected_card if selected_card is not none }}">
            <datalist id="card_list">
                {% for card in cards %}
                    <option value="{{ card.card_name }}">{{ card.card_name }}</option>
                {% endfor %}
            </datalist>

            <input type="hidden" name="action" value="card_focus">
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Sélectionner la carte</button>
        </form>

        <!-- Affichage des informations de la carte sélectionnée -->
        {% if card_info %}
            <div class="p-4 mt-4 bg-gray-100 rounded shadow-lg">
                <h4 class="text-xl font-bold">{{ card_info.card_name }} - Informations</h4>
                <ul>
                    <li><strong>Statut offload</strong> {{ card_info.offload_status }}</li>
                    <li><strong>Capacité:</strong> {{ card_info.capacity }} Go</li>
                    <li><strong>Marque:</strong> {{ card_info.brand }}</li>
                    <li><strong>Type:</strong> {{ card_info.card_type }}</li>
                    <li><strong>Date de naissance:</strong> {{ card_info.card_birth }}</li>
                    <li><strong>Statut de quarantaine:</strong> {{ 'Oui' if card_info.quarantine else 'Non' }}</li>
                    <li><strong>Usage:</strong> {{ card_info.usage }}</li>
                </ul>
        
                <!-- Bouton "Mettre à jour la carte" -->
                <form method="GET" action="{{ url_for('track') }}" class="inline-block mt-4">
                    <input type="hidden" name="source" value="{{ card_info.statut_geo }}">
                    <input type="hidden" name="card" value="{{ card_info.card_name }}">
                    <input type="hidden" name="from_spot" value="true"> <!-- Indique qu'on vient de Spot -->
                    <button type="submit" class="btn">Mettre à jour la carte</button>
                </form>                
            </div>
        {% endif %}

        <!-- Affichage de la timeline -->
        {% if selected_card %}
            <h4 class="mt-4 text-lg font-semibold">Timeline pour la carte {{ selected_card }}</h4>
            <div id="timeline-embed" style="width: 100%; height: 400px"></div>
            <script>
                var timeline_data = {{ timeline_data | tojson }};
                window.timeline = new TL.Timeline('timeline-embed', timeline_data, {
                    start_at_end: true  // Ajoute l'option pour démarrer à la fin
                });
            </script>       
        {% endif %}

    {% elif current_tab == 'geo_focus' %}    <!-- Contenu de Géo Focus -->
    <!-- Statut Géo tab -->
        <form method="POST" action="{{ url_for('spot') }}">
            <input type="hidden" name="action" value="status_geo">
            <input type="hidden" name="current_tab" value="status_geo">
            <div class="flex items-center space-x-4">
                <select id="status_input" name="selected_status" class="border p-2 rounded w-1/3">
                    <option value="" selected>-- Sélectionnez un statut --</option>
                    {% for status in status_geo %}
                        <option value="{{ status.status_name }}" {% if selected_status == status.status_name %}selected{% endif %}>
                            {{ status.status_name }}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Rechercher
                </button>
            </div>
        </form>

        {% if selected_status and cards_by_status %}
        <div class="mt-4">
            <h4 class="text-lg font-semibold mb-2">Cartes pour le statut : {{ selected_status }}</h4>
            <table class="min-w-full table-auto border">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="px-4 py-2 border">Nom de la Carte</th>
                        <th class="px-4 py-2 border">Capacité</th>
                        <th class="px-4 py-2 border">Type</th>
                        <th class="px-4 py-2 border">Dernière Opération</th>
                        <th class="px-4 py-2 border">Utilisateur</th>
                        <th class="px-4 py-2 border">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for card, last_operation_date, last_user in cards_by_status %}
                        <tr>
                            <td class="border px-4 py-2">{{ card.card_name }}</td>
                            <td class="border px-4 py-2">{{ card.capacity }} Go</td>
                            <td class="border px-4 py-2">{{ card.card_type }}</td>
                            <td class="border px-4 py-2">
                                {% if last_operation_date %}
                                    {{ last_operation_date.strftime('%Y-%m-%d %H:%M:%S') if last_operation_date.__class__.__name__ == 'datetime' else last_operation_date }}
                                {% else %}
                                    Aucune
                                {% endif %}
                            </td>
                            <td class="border px-4 py-2">
                                {% if last_user %}
                                    {{ last_user }}
                                {% else %}
                                    Aucun utilisateur
                                {% endif %}
                            </td>
                            <td class="border px-4 py-2">
                                <form method="POST" action="{{ url_for('spot') }}">
                                    <input type="hidden" name="action" value="card_focus">
                                    <input type="hidden" name="selected_card" value="{{ card.card_name }}">
                                    <button type="submit" class="text-blue-500 hover:underline">Voir</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}        


    {% elif current_tab == 'offload_focus' %}    <!-- Contenu de Offload Focus -->
    <!-- Offload Focus tab -->
        <form method="POST" action="{{ url_for('spot') }}">
            <input type="hidden" name="action" value="offload_focus">
            <input type="hidden" name="current_tab" value="offload_focus">
            <div class="flex items-center space-x-4">
                <select id="offload_input" name="selected_offload" class="border p-2 rounded w-1/3">
                    <option value="" selected>-- Sélectionnez un statut offload --</option>
                    {% for status in offload_statuses %}
                        <option value="{{ status.status_name }}" {% if selected_offload == status.status_name %}selected{% endif %}>
                            {{ status.status_name }}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Rechercher
                </button>
            </div>
        </form>
    
        {% if selected_offload and cards_by_offload %}
        <div class="mt-4">
            <h4 class="text-lg font-semibold mb-2">Cartes pour le statut offload : {{ selected_offload }}</h4>
            <table class="min-w-full table-auto border">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="px-4 py-2 border">Nom de la Carte</th>
                        <th class="px-4 py-2 border">Type</th>
                        <th class="px-4 py-2 border">Statut Géo</th>
                        <th class="px-4 py-2 border">Dernière Opération</th>
                        <th class="px-4 py-2 border">Utilisateur</th>
                        <th class="px-4 py-2 border">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for card, last_timestamp, last_user in cards_by_offload %}
                    <tr>
                        <td class="border px-4 py-2">{{ card.card_name }}</td>
                        <td class="border px-4 py-2">{{ card.card_type }}</td>
                        <td class="border px-4 py-2">{{ card.statut_geo }}</td>
                        <td class="border px-4 py-2">
                            {% if last_timestamp %}
                                {{ last_timestamp.strftime('%Y-%m-%d %H:%M:%S') if last_timestamp.__class__.__name__ == 'datetime' else last_timestamp }}
                            {% else %}
                                Aucune
                            {% endif %}
                        </td>
                        <td class="border px-4 py-2">
                            {% if last_user %}
                                {{ last_user }}
                            {% else %}
                                Aucun utilisateur
                            {% endif %}
                        </td>
                        <td class="border px-4 py-2">
                            <form method="POST" action="{{ url_for('spot') }}">
                                <input type="hidden" name="action" value="card_focus">
                                <input type="hidden" name="selected_card" value="{{ card.card_name }}">
                                <button type="submit" class="text-blue-500 hover:underline">Voir</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}                    
                    
                </tbody>
            </table>
        </div>
        {% endif %}

        {% elif current_tab == 'fast_search' %}
        <h2 class="text-2xl font-semibold mb-4">Recherche Rapide</h2>
        
        <!-- Filtres -->
        <div class="flex space-x-4 mb-4">
          <div>
            <label class="block text-sm">Statut Géo</label>
            <select id="filter_geo" class="border p-2 rounded">
              <option value="">Tous</option>
              {% for s in status_geo %}
                <option value="{{ s.status_name }}">{{ s.status_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm">Statut Offload</label>
            <select id="filter_offload" class="border p-2 rounded">
              <option value="">Tous</option>
              {% for o in offload_statuses %}
                <option value="{{ o.status_name }}">{{ o.status_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm">Utilisateur</label>
            <select id="filter_user" class="border p-2 rounded">
              <option value="">Tous</option>
              {% for u in users %}
                <option value="{{ u.username }}">{{ u.username }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        
        <!-- Tableau des cartes -->
        <table id="fast-table" class="min-w-full table-auto border">
          <thead>
            <tr class="bg-gray-100 cursor-pointer">
              <th class="px-4 py-2 border" data-col="0">Carte</th>
              <th class="px-4 py-2 border" data-col="1">Statut Géo</th>
              <th class="px-4 py-2 border" data-col="2">Statut Offload</th>
              <th class="px-4 py-2 border" data-col="3">Dernière Opération</th>
              <th class="px-4 py-2 border" data-col="4">Dernier Utilisateur</th>
              <th class="px-4 py-2 border">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for c, last_user in fast_cards %}
              <tr>
                <td class="border px-4 py-2">{{ c.card_name }}</td>
                <td class="border px-4 py-2">{{ c.statut_geo }}</td>
                <td class="border px-4 py-2">{{ c.offload_status }}</td>
                <td class="border px-4 py-2">
                  {% if c.last_operation %}
                    {{ c.last_operation.strftime('%Y-%m-%d %H:%M:%S') }}
                  {% else %}
                    Aucune
                  {% endif %}
                </td>
                <td class="border px-4 py-2">{{ last_user or 'Aucun' }}</td>
                <td class="border px-4 py-2 flex">
                  <!-- Track -->
                  <form method="GET" action="{{ url_for('track') }}" style="margin-right:8px;">
                    <input type="hidden" name="source"    value="{{ c.statut_geo }}">
                    <input type="hidden" name="card"      value="{{ c.card_name }}">
                    <input type="hidden" name="from_spot" value="true">
                    <button type="submit" class="text-blue-500 hover:underline">Track</button>
                  </form>
                  <!-- Voir (Card Focus) -->
                  <form method="POST" action="{{ url_for('spot') }}">
                    <input type="hidden" name="current_tab"   value="card_focus">
                    <input type="hidden" name="selected_card" value="{{ c.card_name }}">
                    <button type="submit" class="text-blue-500 hover:underline">Voir</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        
        <!-- Scripts de filtrage et de tri -->
        <script>
          // Filtrage
          function filterFast() {
            const geoVal   = document.getElementById('filter_geo').value;
            const oflVal   = document.getElementById('filter_offload').value;
            const userVal  = document.getElementById('filter_user').value;
            document.querySelectorAll('#fast-table tbody tr').forEach(row => {
              const cells = Array.from(row.children).map(td => td.textContent.trim());
              const geo     = cells[1];
              const ofl     = cells[2];
              const user    = cells[4];
              const okGeo   = !geoVal  || geo  === geoVal;
              const okOfl   = !oflVal  || ofl  === oflVal;
              const okUser  = !userVal || user === userVal;
              row.style.display = (okGeo && okOfl && okUser) ? '' : 'none';
            });
          }
          ['filter_geo', 'filter_offload', 'filter_user'].forEach(id =>
            document.getElementById(id).addEventListener('change', filterFast)
          );
        
          // Tri par colonne au double-clic
          (function() {
            const table = document.getElementById('fast-table');
            const headers = table.querySelectorAll('thead th[data-col]');
            headers.forEach(th => {
              let asc = true;
              th.addEventListener('dblclick', () => {
                const colIndex = +th.dataset.col;
                const tbody = table.tBodies[0];
                const rows = Array.from(tbody.rows).filter(r => r.style.display !== 'none');
                rows.sort((a, b) => {
                  let aText = a.cells[colIndex].textContent.trim().toLowerCase();
                  let bText = b.cells[colIndex].textContent.trim().toLowerCase();
                  const aNum = parseFloat(aText), bNum = parseFloat(bText);
                  if (!isNaN(aNum) && !isNaN(bNum)) {
                    return asc ? aNum - bNum : bNum - aNum;
                  }
                  return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
                });
                rows.forEach(r => tbody.appendChild(r));
                asc = !asc;
              });
            });
          })();
        </script>
        {% endif %}
           
        
</div>

{% endblock %}
