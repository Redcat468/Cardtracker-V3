{% extends "layout.html" %}

{% block content %}
<div class="flex items-center justify-center h-full space-x-4">
    <img src="{{ url_for('static', filename='images/manage.png') }}" alt="Target Icon" 
        style="height: 3rem; width: auto;">
    <h1 style="font-size: 2rem; font-weight: 600;">Manage</h1>
<div style="margin-bottom: 5rem;"></div>
</div>

<!-- Onglets de navigation -->
<ul class="flex border-b" id="tabs">
    <li class="mr-1">
        <a href="#" 
           onclick="showTab('card_manager')" 
           class="tab-link bg-white inline-block py-2 px-4 text-blue-500 font-semibold" 
           data-tab="card_manager">Card Manager</a>
    </li>
    <li class="mr-1">
        <a href="#" 
           onclick="showTab('user_manager')" 
           class="tab-link bg-white inline-block py-2 px-4 text-blue-500 font-semibold" 
           data-tab="user_manager">User Manager</a>
    </li>
    <li class="mr-1">
        <a href="#" 
           onclick="showTab('geo_manager')" 
           class="tab-link bg-white inline-block py-2 px-4 text-blue-500 font-semibold" 
           data-tab="geo_manager">Géo Manager</a>
    </li>
    <li class="mr-1">
        <a href="#" 
           onclick="showTab('offload_manager')" 
           class="tab-link bg-white inline-block py-2 px-4 text-blue-500 font-semibold" 
           data-tab="offload_manager">Offload Manager</a>
    </li>
</ul>

<!-- Contenu des onglets -->
<div id="tab_content" class="mt-4">

    <!-- Card Manager Tab -->
    <div id="card_manager" class="tab hidden">
        <h3 class="text-lg font-semibold mb-2">Card Manager</h3>
        
        <!-- Champ de recherche de carte avec menu déroulant filtré -->
        <div class="flex justify-center">
            <form method="POST" action="{{ url_for('manage') }}" class="w-full max-w-3xl">
                <input type="hidden" name="current_tab" value="card_manager">
                <div class="flex justify-between items-center space-x-4">
                    <!-- Champ de recherche -->
                    <div class="flex-1">
                        <input list="card_list" id="card_input" name="selected_card" placeholder="Chercher une carte..." class="w-full border p-2 rounded" value="{{ selected_card if selected_card is not none }}">
                    </div>
                    <!-- Bouton Rechercher -->
                    <div>
                        <button type="submit" class="btn btn-secondary">Rechercher</button>
                    </div>
                    <!-- Bouton Créer une carte -->
                    <div>
                        <a href="{{ url_for('create_card') }}" class="btn btn-secondary">Créer une carte</a>
                    </div>
                </div>
            </form>
        </div>

        <datalist id="card_list">
            {% for card in cards %}
            <option value="{{ card.card_name }}">{{ card.card_name }}</option>
            {% endfor %}
        </datalist>

        <!-- Informations et modification de la carte sélectionnée -->
        {% if selected_card_info %}
        <div class="p-4 mt-4 bg-gray-100 rounded shadow-lg">
            <h4 class="text-xl font-bold mb-4">{{ selected_card_info.card_name }} - Modifier la Carte</h4>
            <form method="POST" action="{{ url_for('update_card') }}">
                <input type="hidden" name="card_id" value="{{ selected_card_info.id }}">
                <div class="mb-4">
                    <label for="offload_status" class="block text-sm font-medium text-gray-700">Statut Offload</label>
                    <select id="offload_status" name="offload_status" class="border p-2 rounded w-full">
                        {% for status in offload_statuses %}
                        <option value="{{ status.status_name }}" {% if selected_card_info.offload_status == status.status_name %}selected{% endif %}>{{ status.status_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4">
                    <label for="statut_geo" class="block text-sm font-medium text-gray-700">Statut Géo</label>
                    <select id="statut_geo" name="statut_geo" class="border p-2 rounded w-full">
                        {% for status in status_geo %}
                        <option value="{{ status.status_name }}" {% if selected_card_info.statut_geo == status.status_name %}selected{% endif %}>{{ status.status_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4 flex items-center" style="gap: 0.2rem;">
                    <input type="checkbox" id="quarantine" name="quarantine" class="mr-2" {% if selected_card_info.quarantine %}checked{% endif %}>
                    <label for="quarantine" class="text-sm text-gray-700">En Quarantaine</label>
                </div>

                <div class="mb-4">
                    <label for="capacity" class="block text-sm font-medium text-gray-700">Capacité (Go)</label>
                    <input type="number" id="capacity" name="capacity" class="border p-2 rounded w-full" value="{{ selected_card_info.capacity }}">
                </div>

                <div class="mb-4">
                    <label for="brand" class="block text-sm font-medium text-gray-700">Marque</label>
                    <input type="text" id="brand" name="brand" class="border p-2 rounded w-full" value="{{ selected_card_info.brand }}">
                </div>

                <div class="mb-4">
                    <label for="card_type" class="block text-sm font-medium text-gray-700">Type de Carte</label>
                    <input type="text" id="card_type" name="card_type" class="border p-2 rounded w-full" value="{{ selected_card_info.card_type }}">
                </div>

                <div class="flex gap-4" style="gap: 1rem;">
                    <button type="submit" class="btn">Enregistrer les modifications</button>
            </form>
            <!-- Bouton Supprimer -->
            <form method="POST" action="{{ url_for('delete_card', card_id=selected_card_info.id) }}">
                <button type="submit" class="btn btn-logout" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette carte ? Cette action est irréversible.')">Supprimer la carte</button>
            </form>
                </div>
        </div>
        {% endif %}
    </div>

    <!-- User Manager Tab -->
    <div id="user_manager" class="tab hidden">
        <h3 class="text-lg font-semibold mb-2">User Manager</h3>
        <p>Contenu pour la gestion des utilisateurs. Ajoutez ici les outils pour gérer les comptes utilisateurs.</p>
    </div>

    <!-- Géo Manager Tab -->
    <div id="geo_manager" class="tab hidden">
        <h3 class="text-lg font-semibold mb-2">Géo Manager</h3>
        <p>Contenu pour la gestion des statuts géographiques. Ajoutez ici les outils pour gérer les statuts géo.</p>
    </div>

    <!-- Offload Manager Tab -->
    <div id="offload_manager" class="tab hidden">
        <h3 class="text-lg font-semibold mb-2">Offload Manager</h3>
        <p>Contenu pour la gestion des statuts d'offload. Ajoutez ici les outils pour gérer les statuts d'offload.</p>
    </div>
</div>

<!-- Script pour gérer les onglets -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tabs = document.querySelectorAll('.tab-link'); // Liens des onglets
        const tabContents = document.querySelectorAll('.tab'); // Contenus des onglets

        console.log("Tabs found:", tabs.length);
        console.log("Tab contents found:", tabContents.length);

        function setActiveTab(tabName) {
            console.log("Switching to tab:", tabName);

            // Réinitialiser tous les onglets et masquer tous les contenus
            tabs.forEach(tab => {
                tab.classList.remove('border-b-4', 'border-blue-500', 'text-blue-600');
                tab.classList.add('text-blue-500');
            });
            tabContents.forEach(content => {
                content.classList.add('hidden');
                console.log("Hiding tab:", content.id);
            });

            // Activer l'onglet sélectionné et afficher son contenu
            const activeTab = document.querySelector(`.tab-link[data-tab="${tabName}"]`);
            const activeContent = document.getElementById(tabName);

            if (activeTab) {
                activeTab.classList.add('border-b-4', 'border-blue-500', 'text-blue-600');
                activeTab.classList.remove('text-blue-500');
                console.log("Activated tab:", activeTab.getAttribute('data-tab'));
            }

            if (activeContent) {
                activeContent.classList.remove('hidden');
                console.log("Showing tab content:", activeContent.id);
            }
        }

        // Gérer les clics sur les onglets
        tabs.forEach(tab => {
            tab.addEventListener('click', event => {
                event.preventDefault();
                const tabName = tab.getAttribute('data-tab');
                setActiveTab(tabName);
            });
        });

        // Activer un onglet par défaut
        setActiveTab("card_manager"); // Onglet actif par défaut
    });

</script>

{% endblock %}